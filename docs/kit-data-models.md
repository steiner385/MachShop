# Kitting & Material Staging System - Data Models

## Overview
This document outlines the data models for the Kitting & Material Staging System that supports complex engine assembly operations with 25,000+ parts.

## Kit Model

```prisma
model Kit {
  id                 String           @id @default(cuid())
  kitNumber          String           @unique
  kitName            String?
  workOrderId        String
  operationId        String?
  assemblyStage      String?          // Fan, Compressor, Combustor, Turbine, Integration
  workCellId         String?
  status             KitStatus        @default(PLANNED)
  priority           KitPriority      @default(NORMAL)

  // Staging information
  stagingLocationId  String?
  stagedAt           DateTime?
  stagedById         String?

  // Issue tracking
  issuedAt           DateTime?
  issuedById         String?
  issuedToId         String?

  // Consumption tracking
  isPartiallyConsumed Boolean         @default(false)
  completionPercent   Float?          @default(0)

  // Return processing
  returnedAt         DateTime?
  returnedById       String?
  returnReason       String?

  // Vendor kitting
  isVendorKit        Boolean          @default(false)
  vendorId           String?
  vendorKitNumber    String?
  vendorReceivedAt   DateTime?

  // Planning and generation
  autoGenerated      Boolean          @default(false)
  generatedFromBOM   Boolean          @default(false)
  scrapFactor        Float?           @default(0.05)  // 5% default scrap allowance

  // Scheduling
  requiredByDate     DateTime?
  plannedStageDate   DateTime?
  plannedIssueDate   DateTime?

  // Audit and compliance
  notes              String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  createdById        String

  // Relationships
  workOrder          WorkOrder        @relation(fields: [workOrderId], references: [id])
  operation          Operation?       @relation(fields: [operationId], references: [id])
  stagingLocation    StagingLocation? @relation(fields: [stagingLocationId], references: [id])
  createdBy          User             @relation("KitCreatedBy", fields: [createdById], references: [id])
  stagedBy           User?            @relation("KitStagedBy", fields: [stagedById], references: [id])
  issuedBy           User?            @relation("KitIssuedBy", fields: [issuedById], references: [id])
  issuedTo           User?            @relation("KitIssuedTo", fields: [issuedToId], references: [id])
  returnedBy         User?            @relation("KitReturnedBy", fields: [returnedById], references: [id])

  // Child relationships
  kitItems           KitItem[]
  statusHistory      KitStatusHistory[]
  shortageAlerts     KitShortageAlert[]

  @@index([workOrderId])
  @@index([status])
  @@index([stagingLocationId])
  @@index([requiredByDate])
  @@index([operationId])
  @@map("kits")
}

enum KitStatus {
  PLANNED           // Kit created but not yet staged
  STAGING           // Being picked and staged
  STAGED            // Ready for issue at staging location
  ISSUED            // Issued to production
  PARTIAL           // Partially consumed
  CONSUMED          // Fully consumed
  RETURNED          // Returned unused materials
  CANCELLED         // Kit cancelled
  ON_HOLD           // Temporarily on hold
}

enum KitPriority {
  LOW
  NORMAL
  HIGH
  URGENT
  CRITICAL
}
```

## KitItem Model

```prisma
model KitItem {
  id                 String            @id @default(cuid())
  kitId              String
  partId             String?           // For parts
  materialLotId      String?           // For specific material lots
  inventoryId        String?           // For general inventory
  toolId             String?           // For tools and equipment

  // Quantity information
  requiredQuantity   Float
  stagedQuantity     Float             @default(0)
  issuedQuantity     Float             @default(0)
  consumedQuantity   Float             @default(0)
  returnedQuantity   Float             @default(0)
  shortageQuantity   Float             @default(0)

  unitOfMeasure      String
  unitOfMeasureId    String?           // FK to UnitOfMeasure

  // BOM reference
  bomItemId          String?           // Reference to source BOM item
  sequence           Int?              // Picking sequence
  findNumber         String?           // Engineering find number
  referenceDesignator String?          // Component reference

  // Status tracking
  status             KitItemStatus     @default(PLANNED)
  isPicked           Boolean           @default(false)
  isStaged           Boolean           @default(false)
  isIssued           Boolean           @default(false)

  // Location tracking
  pickLocationId     String?
  stagedLocationId   String?

  // Special handling
  isCritical         Boolean           @default(false)
  isHazardous        Boolean           @default(false)
  specialInstructions String?

  // Vendor information
  preferredSupplierId String?
  supplierPartNumber  String?

  // Audit
  notes              String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  // Relationships
  kit                Kit               @relation(fields: [kitId], references: [id], onDelete: Cascade)
  part               Part?             @relation(fields: [partId], references: [id])
  materialLot        MaterialLot?      @relation(fields: [materialLotId], references: [id])
  inventory          Inventory?        @relation(fields: [inventoryId], references: [id])
  bomItem            BOMItem?          @relation(fields: [bomItemId], references: [id])
  unitOfMeasureRef   UnitOfMeasure?    @relation("KitItemUOM", fields: [unitOfMeasureId], references: [id])

  @@index([kitId])
  @@index([partId])
  @@index([status])
  @@index([isPicked])
  @@index([isStaged])
  @@map("kit_items")
}

enum KitItemStatus {
  PLANNED           // Item identified but not yet picked
  PICKING           // Being picked from inventory
  PICKED            // Picked and ready for staging
  STAGED            // Staged at kit location
  ISSUED            // Issued with kit
  CONSUMED          // Used in production
  RETURNED          // Returned unused
  SHORT             // Shortage identified
  SUBSTITUTED       // Substituted with alternate part
}
```

## StagingLocation Model

```prisma
model StagingLocation {
  id                 String              @id @default(cuid())
  locationCode       String              @unique
  locationName       String
  description        String?

  // Physical characteristics
  areaId             String?
  zoneCode           String?
  coordinates        String?             // Physical coordinates (x,y,z or GPS)
  maxCapacity        Int?                // Max number of kits
  currentOccupancy   Int                 @default(0)

  // Location type and capabilities
  locationType       StagingLocationType @default(GENERAL)
  securityLevel      SecurityLevel       @default(STANDARD)
  hasClimateControl  Boolean             @default(false)
  hasSecurityCamera  Boolean             @default(false)
  hasAccessControl   Boolean             @default(false)

  // Work cell proximity
  nearWorkCells      String[]            // Array of work cell IDs for optimization
  proximityScore     Float?              // Distance-based scoring for assignment

  // Environmental conditions
  temperatureMin     Float?
  temperatureMax     Float?
  humidityMax        Float?
  isCleanRoom        Boolean             @default(false)
  esdProtected       Boolean             @default(false)

  // Operational status
  isActive           Boolean             @default(true)
  isAvailable        Boolean             @default(true)
  maintenanceMode    Boolean             @default(false)

  // Barcode/RFID integration
  barcodeId          String?
  rfidTagId          String?

  // Audit
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  // Relationships
  area               Area?               @relation(fields: [areaId], references: [id])
  kits               Kit[]

  @@index([areaId])
  @@index([locationType])
  @@index([isActive])
  @@index([isAvailable])
  @@map("staging_locations")
}

enum StagingLocationType {
  GENERAL           // General purpose staging
  CLEAN_ROOM        // Clean room environment
  HAZMAT            // Hazardous materials
  TOOL_CRIB         // Tool and equipment staging
  VENDOR_KIT        // Vendor-supplied kits
  QUARANTINE        // Quarantine area
  HIGH_VALUE        // High-value items
  BULK_MATERIAL     // Bulk materials
}

enum SecurityLevel {
  OPEN              // Open access
  STANDARD          // Standard security
  RESTRICTED        // Restricted access
  CLASSIFIED        // Classified/secure area
}
```

## Supporting Models

```prisma
model KitStatusHistory {
  id              String      @id @default(cuid())
  kitId           String
  fromStatus      KitStatus?
  toStatus        KitStatus
  changedAt       DateTime    @default(now())
  changedById     String
  reason          String?
  notes           String?

  kit             Kit         @relation(fields: [kitId], references: [id], onDelete: Cascade)
  changedBy       User        @relation(fields: [changedById], references: [id])

  @@index([kitId])
  @@index([changedAt])
  @@map("kit_status_history")
}

model KitShortageAlert {
  id              String           @id @default(cuid())
  kitId           String
  kitItemId       String?
  partId          String
  shortageQuantity Float
  requiredByDate  DateTime?
  priority        AlertPriority    @default(NORMAL)
  status          AlertStatus      @default(OPEN)

  // Alert details
  alertMessage    String
  actionRequired  String?
  assignedToId    String?

  // Resolution
  resolvedAt      DateTime?
  resolvedById    String?
  resolution      String?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  kit             Kit              @relation(fields: [kitId], references: [id], onDelete: Cascade)
  part            Part             @relation(fields: [partId], references: [id])
  assignedTo      User?            @relation("ShortageAssigned", fields: [assignedToId], references: [id])
  resolvedBy      User?            @relation("ShortageResolved", fields: [resolvedById], references: [id])

  @@index([kitId])
  @@index([status])
  @@index([priority])
  @@index([requiredByDate])
  @@map("kit_shortage_alerts")
}

enum AlertPriority {
  LOW
  NORMAL
  HIGH
  URGENT
  CRITICAL
}

enum AlertStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  RESOLVED
  CLOSED
  CANCELLED
}
```

## Integration Points

### Existing Model Updates

#### Part Model
- Add relationship: `kitItems KitItem[]`
- Add relationship: `shortageAlerts KitShortageAlert[]`

#### BOMItem Model
- Add relationship: `kitItems KitItem[]`

#### MaterialLot Model
- Add relationship: `kitItems KitItem[]`

#### Inventory Model
- Add relationship: `kitItems KitItem[]`

#### Area Model
- Add relationship: `stagingLocations StagingLocation[]`

#### User Model
- Add relationships for kit management:
  ```prisma
  kitsCreated      Kit[] @relation("KitCreatedBy")
  kitsStaged       Kit[] @relation("KitStagedBy")
  kitsIssued       Kit[] @relation("KitIssuedBy")
  kitsReceived     Kit[] @relation("KitIssuedTo")
  kitsReturned     Kit[] @relation("KitReturnedBy")
  kitStatusChanges KitStatusHistory[]
  shortagesAssigned KitShortageAlert[] @relation("ShortageAssigned")
  shortagesResolved KitShortageAlert[] @relation("ShortageResolved")
  ```

### Key Design Decisions

1. **Flexible Kit Items**: Support parts, material lots, inventory, and tools in the same kit
2. **Status Workflow**: Complete lifecycle tracking from planning to consumption
3. **Staging Optimization**: Location assignment based on work cell proximity
4. **Shortage Management**: Proactive shortage identification and alerting
5. **Vendor Integration**: Support for pre-kitted assemblies from suppliers
6. **Audit Trail**: Complete traceability for AS9100 compliance
7. **Multi-level Support**: Kit items can reference BOM items for traceability
8. **Flexible Relationships**: Support both specific lots and general inventory

This design supports the complex requirements of engine assembly with 25,000+ parts while maintaining flexibility for different kitting scenarios.