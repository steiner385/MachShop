<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES Database Schema Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1890ff;
            border-bottom: 3px solid #1890ff;
            padding-bottom: 10px;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #fafafa;
            border-radius: 4px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-box {
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-radius: 3px;
        }
        .sprint3 { background: #52c41a; }
        .sprint2 { background: #1890ff; }
        .sprint1 { background: #faad14; }
        .core { background: #f0f0f0; }
        #schema-container {
            width: 100%;
            height: 800px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            overflow: auto;
            background: #ffffff;
        }
        .table-box {
            cursor: move;
            transition: transform 0.2s;
        }
        .table-box:hover {
            transform: scale(1.02);
        }
        .table-header {
            fill: #1890ff;
            stroke: #096dd9;
            stroke-width: 2;
        }
        .table-header-sprint3 {
            fill: #52c41a;
            stroke: #389e0d;
            stroke-width: 2;
        }
        .table-header-sprint2 {
            fill: #1890ff;
            stroke: #096dd9;
            stroke-width: 2;
        }
        .table-body {
            fill: white;
            stroke: #d9d9d9;
            stroke-width: 1;
        }
        .table-name {
            font-weight: bold;
            font-size: 14px;
            fill: white;
        }
        .field-text {
            font-size: 12px;
            fill: #333;
        }
        .field-type {
            font-size: 11px;
            fill: #666;
        }
        .relation-line {
            stroke: #1890ff;
            stroke-width: 2;
            fill: none;
            opacity: 0.6;
        }
        .relation-line:hover {
            stroke-width: 3;
            opacity: 1;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            border-color: #1890ff;
            color: #1890ff;
        }
        .btn-primary {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        .btn-primary:hover {
            background: #40a9ff;
        }
        .info-panel {
            margin: 20px 0;
            padding: 15px;
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è MES Database Schema Visualization</h1>

        <div class="info-panel">
            <strong>Database:</strong> PostgreSQL | <strong>ORM:</strong> Prisma | <strong>Total Tables:</strong> <span id="table-count">0</span>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-box sprint3"></div>
                <span><strong>Sprint 3</strong> - FAI & AS9102</span>
            </div>
            <div class="legend-item">
                <div class="legend-box sprint2"></div>
                <span><strong>Sprint 2</strong> - Digital Work Instructions & E-Signatures</span>
            </div>
            <div class="legend-item">
                <div class="legend-box sprint1"></div>
                <span><strong>Sprint 1</strong> - Foundation</span>
            </div>
            <div class="legend-item">
                <div class="legend-box core"></div>
                <span><strong>Core</strong> - Original MES System</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="resetView()">Reset View</button>
            <button class="btn" onclick="showSprint3Only()">Show Sprint 3 Only</button>
            <button class="btn" onclick="showSprint2Only()">Show Sprint 2 Only</button>
            <button class="btn" onclick="showAll()">Show All Tables</button>
            <button class="btn" onclick="exportSVG()">Export SVG</button>
        </div>

        <div id="schema-container"></div>
    </div>

    <script>
        // Database schema data
        const schema = {
            // Sprint 3 - FAI (AS9102 First Article Inspection)
            FAIReport: {
                sprint: 3,
                fields: [
                    { name: 'id', type: 'String', pk: true },
                    { name: 'faiNumber', type: 'String', unique: true },
                    { name: 'partId', type: 'String', fk: 'Part' },
                    { name: 'workOrderId', type: 'String?', fk: 'WorkOrder' },
                    { name: 'status', type: 'FAIStatus' },
                    { name: 'revisionLevel', type: 'String?' },
                    { name: 'form1Data', type: 'Json?' },
                    { name: 'form2Data', type: 'Json?' },
                    { name: 'createdAt', type: 'DateTime' },
                ],
                relations: ['FAICharacteristic']
            },
            FAICharacteristic: {
                sprint: 3,
                fields: [
                    { name: 'id', type: 'String', pk: true },
                    { name: 'faiReportId', type: 'String', fk: 'FAIReport' },
                    { name: 'characteristicNumber', type: 'Int' },
                    { name: 'characteristic', type: 'String' },
                    { name: 'specification', type: 'String' },
                    { name: 'nominalValue', type: 'Float?' },
                    { name: 'upperLimit', type: 'Float?' },
                    { name: 'lowerLimit', type: 'Float?' },
                    { name: 'measuredValues', type: 'Json' },
                    { name: 'result', type: 'String?' },
                ],
                relations: []
            },

            // Sprint 2 - Electronic Signatures & Work Instructions
            ElectronicSignature: {
                sprint: 2,
                fields: [
                    { name: 'id', type: 'String', pk: true },
                    { name: 'signatureType', type: 'ElectronicSignatureType' },
                    { name: 'signatureLevel', type: 'ElectronicSignatureLevel' },
                    { name: 'userId', type: 'String', fk: 'User' },
                    { name: 'signedEntityType', type: 'String' },
                    { name: 'signedEntityId', type: 'String' },
                    { name: 'signatureHash', type: 'String' },
                    { name: 'biometricType', type: 'BiometricType?' },
                    { name: 'isValid', type: 'Boolean' },
                    { name: 'timestamp', type: 'DateTime' },
                ],
                relations: []
            },
            WorkInstruction: {
                sprint: 2,
                fields: [
                    { name: 'id', type: 'String', pk: true },
                    { name: 'title', type: 'String' },
                    { name: 'description', type: 'String?' },
                    { name: 'partId', type: 'String?', fk: 'Part' },
                    { name: 'version', type: 'String' },
                    { name: 'status', type: 'WorkInstructionStatus' },
                    { name: 'createdById', type: 'String', fk: 'User' },
                    { name: 'approvedById', type: 'String?', fk: 'User' },
                ],
                relations: ['WorkInstructionStep']
            },
            WorkInstructionStep: {
                sprint: 2,
                fields: [
                    { name: 'id', type: 'String', pk: true },
                    { name: 'workInstructionId', type: 'String', fk: 'WorkInstruction' },
                    { name: 'stepNumber', type: 'Int' },
                    { name: 'title', type: 'String' },
                    { name: 'content', type: 'String' },
                    { name: 'imageUrls', type: 'String[]' },
                    { name: 'requiresSignature', type: 'Boolean' },
                ],
                relations: []
            },

            // Core MES Tables
            User: {
                sprint: 0,
                fields: [
                    { name: 'id', type: 'String', pk: true },
                    { name: 'username', type: 'String', unique: true },
                    { name: 'email', type: 'String', unique: true },
                    { name: 'passwordHash', type: 'String' },
                    { name: 'roles', type: 'String[]' },
                    { name: 'isActive', type: 'Boolean' },
                ],
                relations: ['WorkOrder', 'QualityInspection', 'NCR']
            },
            Part: {
                sprint: 0,
                fields: [
                    { name: 'id', type: 'String', pk: true },
                    { name: 'partNumber', type: 'String', unique: true },
                    { name: 'partName', type: 'String' },
                    { name: 'partType', type: 'String' },
                    { name: 'drawingNumber', type: 'String?' },
                    { name: 'revision', type: 'String?' },
                ],
                relations: ['WorkOrder', 'QualityPlan', 'BOMItem']
            },
            WorkOrder: {
                sprint: 0,
                fields: [
                    { name: 'id', type: 'String', pk: true },
                    { name: 'workOrderNumber', type: 'String', unique: true },
                    { name: 'partId', type: 'String', fk: 'Part' },
                    { name: 'quantity', type: 'Int' },
                    { name: 'status', type: 'WorkOrderStatus' },
                    { name: 'createdById', type: 'String', fk: 'User' },
                ],
                relations: ['WorkOrderOperation', 'QualityInspection']
            },
            QualityInspection: {
                sprint: 0,
                fields: [
                    { name: 'id', type: 'String', pk: true },
                    { name: 'inspectionNumber', type: 'String', unique: true },
                    { name: 'workOrderId', type: 'String', fk: 'WorkOrder' },
                    { name: 'inspectorId', type: 'String', fk: 'User' },
                    { name: 'status', type: 'QualityInspectionStatus' },
                    { name: 'result', type: 'QualityInspectionResult?' },
                ],
                relations: ['QualityMeasurement', 'NCR']
            },
            NCR: {
                sprint: 0,
                fields: [
                    { name: 'id', type: 'String', pk: true },
                    { name: 'ncrNumber', type: 'String', unique: true },
                    { name: 'workOrderId', type: 'String?', fk: 'WorkOrder' },
                    { name: 'defectType', type: 'String' },
                    { name: 'severity', type: 'NCRSeverity' },
                    { name: 'status', type: 'NCRStatus' },
                ],
                relations: []
            },
        };

        // Initialize visualization
        const width = 1500;
        const height = 800;
        const svg = d3.select('#schema-container')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        const g = svg.append('g');

        // Update table count
        document.getElementById('table-count').textContent = Object.keys(schema).length;

        // Calculate positions for tables
        const tableWidth = 220;
        const tableHeaderHeight = 30;
        const fieldHeight = 20;
        const padding = 40;
        const cols = 5;

        let tablePositions = {};
        let currentX = padding;
        let currentY = padding;
        let col = 0;

        Object.keys(schema).forEach((tableName, index) => {
            const table = schema[tableName];
            const tableHeight = tableHeaderHeight + (table.fields.length * fieldHeight) + 10;

            tablePositions[tableName] = { x: currentX, y: currentY, width: tableWidth, height: tableHeight };

            col++;
            if (col >= cols) {
                col = 0;
                currentX = padding;
                currentY += 280;
            } else {
                currentX += tableWidth + padding;
            }
        });

        // Draw tables
        Object.keys(schema).forEach(tableName => {
            const table = schema[tableName];
            const pos = tablePositions[tableName];

            const tableGroup = g.append('g')
                .attr('class', 'table-box')
                .attr('transform', `translate(${pos.x}, ${pos.y})`);

            // Header
            let headerClass = 'table-header';
            if (table.sprint === 3) headerClass = 'table-header-sprint3';
            if (table.sprint === 2) headerClass = 'table-header-sprint2';

            tableGroup.append('rect')
                .attr('class', headerClass)
                .attr('width', tableWidth)
                .attr('height', tableHeaderHeight)
                .attr('rx', 4);

            tableGroup.append('text')
                .attr('class', 'table-name')
                .attr('x', tableWidth / 2)
                .attr('y', tableHeaderHeight / 2 + 5)
                .attr('text-anchor', 'middle')
                .text(tableName);

            // Body
            tableGroup.append('rect')
                .attr('class', 'table-body')
                .attr('y', tableHeaderHeight)
                .attr('width', tableWidth)
                .attr('height', table.fields.length * fieldHeight + 10)
                .attr('rx', 4);

            // Fields
            table.fields.forEach((field, i) => {
                const fieldY = tableHeaderHeight + 15 + (i * fieldHeight);

                let fieldDisplay = field.name;
                if (field.pk) fieldDisplay = 'üîë ' + fieldDisplay;
                if (field.fk) fieldDisplay = 'üîó ' + fieldDisplay;
                if (field.unique) fieldDisplay += ' üîí';

                tableGroup.append('text')
                    .attr('class', 'field-text')
                    .attr('x', 10)
                    .attr('y', fieldY)
                    .text(fieldDisplay);

                tableGroup.append('text')
                    .attr('class', 'field-type')
                    .attr('x', tableWidth - 10)
                    .attr('y', fieldY)
                    .attr('text-anchor', 'end')
                    .text(field.type);
            });
        });

        // Draw relations
        Object.keys(schema).forEach(tableName => {
            const table = schema[tableName];
            const fromPos = tablePositions[tableName];

            table.fields.forEach(field => {
                if (field.fk && schema[field.fk]) {
                    const toPos = tablePositions[field.fk];

                    g.append('path')
                        .attr('class', 'relation-line')
                        .attr('d', `M ${fromPos.x + tableWidth / 2} ${fromPos.y + fromPos.height / 2}
                                    L ${toPos.x + tableWidth / 2} ${toPos.y + toPos.height / 2}`);
                }
            });
        });

        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.3, 3])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Control functions
        function resetView() {
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity.translate(0, 0).scale(1)
            );
        }

        function showSprint3Only() {
            g.selectAll('.table-box').style('opacity', 0.1);
            Object.keys(schema).forEach(tableName => {
                if (schema[tableName].sprint === 3) {
                    g.selectAll('.table-box').filter(function() {
                        return d3.select(this).select('.table-name').text() === tableName;
                    }).style('opacity', 1);
                }
            });
        }

        function showSprint2Only() {
            g.selectAll('.table-box').style('opacity', 0.1);
            Object.keys(schema).forEach(tableName => {
                if (schema[tableName].sprint === 2) {
                    g.selectAll('.table-box').filter(function() {
                        return d3.select(this).select('.table-name').text() === tableName;
                    }).style('opacity', 1);
                }
            });
        }

        function showAll() {
            g.selectAll('.table-box').style('opacity', 1);
        }

        function exportSVG() {
            const svgData = svg.node().outerHTML;
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mes-schema.svg';
            a.click();
        }
    </script>
</body>
</html>
